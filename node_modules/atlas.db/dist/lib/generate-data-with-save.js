"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const parse_and_validate_raw_data_1 = __importDefault(require("./parse-and-validate-raw-data"));
const parse_to_raw_data_1 = __importDefault(require("./parse-to-raw-data"));
function generateDataWithSave(path, tableData, structure) {
    function deleteSaveFunction(data) {
        delete data?.save;
        return data;
    }
    return {
        ...(0, parse_to_raw_data_1.default)(tableData, structure),
        save: function () {
            const data = JSON.parse(fs_1.default.readFileSync(path, 'utf-8'));
            const rawData = deleteSaveFunction(this);
            const previousLocalData = data.find((ref) => ref.id == rawData.id);
            const localDataIndex = data.indexOf(previousLocalData);
            if (typeof localDataIndex !== 'number')
                return;
            const parsedAndValidatedData = (0, parse_and_validate_raw_data_1.default)(rawData, structure.props);
            if (!parsedAndValidatedData) {
                return false;
            }
            Object.entries(parsedAndValidatedData).forEach(([ref, val]) => {
                data[localDataIndex][ref] = val;
            });
            fs_1.default.writeFileSync(path, JSON.stringify(data, null, 2), 'utf-8');
            return data;
        }
    };
}
exports.default = generateDataWithSave;
